# SBOM Attestation Verification Guide

**Purpose**: Guide for verifying SBOM (Software Bill of Materials) attestations on container images  
**Date**: 2025-01-17  
**Audience**: Security engineers, operations teams, compliance auditors

## Overview

All container images published from the main branch of this repository include:
1. **SLSA Provenance Attestations** - Cryptographically verifiable metadata about the build process
2. **SBOM Attestations** - Software Bill of Materials cryptographically bound to the exact container image

These attestations provide:
- **Complete component inventory**: All dependencies, libraries, and packages in the container
- **Vulnerability tracking**: Ability to identify affected images when CVEs are disclosed
- **License compliance**: Clear view of all software licenses in use
- **Supply chain security**: Cryptographic binding between SBOM and the exact image digest

## Quick Start

Verify SBOM attestation in under 60 seconds:

```bash
# Install cosign (one-time setup)
go install github.com/sigstore/cosign/v2/cmd/cosign@latest

# Verify SBOM attestation signature
cosign verify-attestation \
  --type https://spdx.dev/Document \
  --certificate-identity-regexp '^https://github.com/infobloxopen/ib-schema-registry/' \
  --certificate-oidc-issuer https://token.actions.githubusercontent.com \
  ghcr.io/infobloxopen/ib-schema-registry:latest

# Extract and view SBOM contents
cosign verify-attestation \
  --type https://spdx.dev/Document \
  --certificate-identity-regexp '^https://github.com/infobloxopen/ib-schema-registry/' \
  --certificate-oidc-issuer https://token.actions.githubusercontent.com \
  ghcr.io/infobloxopen/ib-schema-registry:latest \
  | jq -r '.payload | @base64d | fromjson | .predicate' > sbom.spdx.json
```

## SBOM Generation Process

### When SBOMs are Generated

SBOM generation occurs **only** on pushes to the `main` branch:

- ✅ **Main branch pushes**: SBOM generated and attested
- ❌ **Pull requests**: No SBOM generation (build-only)
- ❌ **Feature branches**: No SBOM generation (build-only)
- ✅ **Tags (e.g., v1.0.0)**: SBOM generated (if pushed to main)

### Multi-Architecture Support

SBOMs are generated for both supported architectures:
- `linux/amd64` - AMD64/x86_64 architecture
- `linux/arm64` - ARM64/aarch64 architecture

Each architecture has its own SBOM attestation bound to the architecture-specific image digest.

### SBOM Formats

Two formats are generated for each architecture:

1. **SPDX 2.3** (Used for attestations)
   - ISO/IEC 5962 standard
   - Best for license compliance
   - Attestation predicate type: `https://spdx.dev/Document`

2. **CycloneDX 1.5** (Available as artifact)
   - OWASP standard
   - Best for vulnerability scanning
   - Preferred by tools like Grype, Trivy, Snyk

## Verification Methods

### Method 1: Verify SBOM Attestation Signature (Recommended)

Verify that the SBOM was generated by trusted GitHub Actions and bound to the image:

```bash
# Verify SBOM attestation
cosign verify-attestation \
  --type https://spdx.dev/Document \
  --certificate-identity-regexp '^https://github.com/infobloxopen/ib-schema-registry/' \
  --certificate-oidc-issuer https://token.actions.githubusercontent.com \
  ghcr.io/infobloxopen/ib-schema-registry:latest
```

**What this verifies:**
- ✅ SBOM was generated by GitHub Actions from this repository
- ✅ SBOM is cryptographically bound to the exact image digest
- ✅ SBOM has not been tampered with since generation
- ✅ Build workflow identity matches expected pattern

### Method 2: Extract and Inspect SBOM

Extract the SBOM for analysis:

```bash
# Extract SBOM in SPDX format
cosign verify-attestation \
  --type https://spdx.dev/Document \
  --certificate-identity-regexp '^https://github.com/infobloxopen/ib-schema-registry/' \
  --certificate-oidc-issuer https://token.actions.githubusercontent.com \
  ghcr.io/infobloxopen/ib-schema-registry:latest \
  | jq -r '.payload | @base64d | fromjson | .predicate' > sbom.spdx.json

# View SBOM summary
cat sbom.spdx.json | jq '{
  name: .name,
  version: .spdxVersion,
  packages: .packages | length,
  creator: .creationInfo.creators
}'
```

### Method 3: Download from GitHub Actions Artifacts

SBOMs are also stored as workflow artifacts (90-day retention):

```bash
# Using GitHub CLI
gh run list --repo infobloxopen/ib-schema-registry --branch main --limit 1
gh run download <run-id> -n sbom-artifacts

# Files downloaded:
# - sbom-amd64.cyclonedx.json
# - sbom-amd64.spdx.json
# - sbom-arm64.cyclonedx.json
# - sbom-arm64.spdx.json
```

### Method 4: Verify SBOM Matches Image Digest

Ensure the SBOM attestation references the correct image:

```bash
# Get image digest
IMAGE_DIGEST=$(docker inspect ghcr.io/infobloxopen/ib-schema-registry:latest \
  --format='{{index .RepoDigests 0}}' | cut -d'@' -f2)

echo "Image digest: ${IMAGE_DIGEST}"

# Extract SBOM subject digest
cosign verify-attestation \
  --type https://spdx.dev/Document \
  --certificate-identity-regexp '^https://github.com/infobloxopen/ib-schema-registry/' \
  --certificate-oidc-issuer https://token.actions.githubusercontent.com \
  ghcr.io/infobloxopen/ib-schema-registry:latest \
  | jq -r '.[0].payload | @base64d | fromjson | .subject[0].digest.sha256'

# Both should match
```

## Vulnerability Scanning with SBOM

### Using Grype

Scan the SBOM for vulnerabilities:

```bash
# Extract SBOM
cosign verify-attestation \
  --type https://spdx.dev/Document \
  --certificate-identity-regexp '^https://github.com/infobloxopen/ib-schema-registry/' \
  --certificate-oidc-issuer https://token.actions.githubusercontent.com \
  ghcr.io/infobloxopen/ib-schema-registry:latest \
  | jq -r '.payload | @base64d | fromjson | .predicate' > sbom.spdx.json

# Scan with Grype
grype sbom:./sbom.spdx.json
```

### Using Trivy

```bash
# Extract SBOM
cosign verify-attestation \
  --type https://spdx.dev/Document \
  --certificate-identity-regexp '^https://github.com/infobloxopen/ib-schema-registry/' \
  --certificate-oidc-issuer https://token.actions.githubusercontent.com \
  ghcr.io/infobloxopen/ib-schema-registry:latest \
  | jq -r '.payload | @base64d | fromjson | .predicate' > sbom.spdx.json

# Scan with Trivy
trivy sbom sbom.spdx.json
```

### Using Snyk

```bash
# Download CycloneDX SBOM from artifacts (Snyk prefers CycloneDX)
gh run download <run-id> -n sbom-artifacts

# Scan with Snyk
snyk test --file=sbom-amd64.cyclonedx.json --package-manager=deb
```

## License Compliance

Extract license information from SBOM:

```bash
# Extract all licenses used
cosign verify-attestation \
  --type https://spdx.dev/Document \
  --certificate-identity-regexp '^https://github.com/infobloxopen/ib-schema-registry/' \
  --certificate-oidc-issuer https://token.actions.githubusercontent.com \
  ghcr.io/infobloxopen/ib-schema-registry:latest \
  | jq -r '.payload | @base64d | fromjson | .predicate.packages[] | 
    select(.licenseConcluded != "NOASSERTION") | 
    {name: .name, version: .versionInfo, license: .licenseConcluded}'
```

## Component Inventory

List all packages in the image:

```bash
# List all packages with versions
cosign verify-attestation \
  --type https://spdx.dev/Document \
  --certificate-identity-regexp '^https://github.com/infobloxopen/ib-schema-registry/' \
  --certificate-oidc-issuer https://token.actions.githubusercontent.com \
  ghcr.io/infobloxopen/ib-schema-registry:latest \
  | jq -r '.payload | @base64d | fromjson | .predicate.packages[] | 
    "\(.name) - \(.versionInfo)"' | sort
```

## Advanced Verification

### Verify Both Provenance and SBOM

Complete supply chain verification:

```bash
#!/bin/bash
set -e

IMAGE="ghcr.io/infobloxopen/ib-schema-registry:latest"

echo "=== Verifying Build Provenance ==="
cosign verify-attestation \
  --type slsaprovenance \
  --certificate-identity-regexp '^https://github.com/infobloxopen/ib-schema-registry/' \
  --certificate-oidc-issuer https://token.actions.githubusercontent.com \
  "$IMAGE"

echo "✅ Build provenance verified"
echo ""

echo "=== Verifying SBOM Attestation ==="
cosign verify-attestation \
  --type https://spdx.dev/Document \
  --certificate-identity-regexp '^https://github.com/infobloxopen/ib-schema-registry/' \
  --certificate-oidc-issuer https://token.actions.githubusercontent.com \
  "$IMAGE"

echo "✅ SBOM attestation verified"
echo ""

echo "=== Extracting SBOM ==="
cosign verify-attestation \
  --type https://spdx.dev/Document \
  --certificate-identity-regexp '^https://github.com/infobloxopen/ib-schema-registry/' \
  --certificate-oidc-issuer https://token.actions.githubusercontent.com \
  "$IMAGE" \
  | jq -r '.payload | @base64d | fromjson | .predicate' > sbom.spdx.json

echo "✅ SBOM extracted to sbom.spdx.json"
echo ""

echo "=== SBOM Summary ==="
cat sbom.spdx.json | jq '{
  name: .name,
  version: .spdxVersion,
  packages: (.packages | length),
  createdBy: .creationInfo.creators[0],
  created: .creationInfo.created
}'
```

### Verify Specific Workflow Run

Verify SBOM was generated from a specific workflow run:

```bash
# Get workflow run ID from GitHub Actions UI or API
WORKFLOW_RUN_ID="12345678"

# Verify SBOM includes workflow run metadata
cosign verify-attestation \
  --type https://spdx.dev/Document \
  --certificate-identity-regexp '^https://github.com/infobloxopen/ib-schema-registry/' \
  --certificate-oidc-issuer https://token.actions.githubusercontent.com \
  ghcr.io/infobloxopen/ib-schema-registry:latest \
  | jq -r '.payload | @base64d | fromjson | 
    select(.predicate.documentNamespace | contains("'$WORKFLOW_RUN_ID'"))'
```

## Troubleshooting

### "no matching attestations" Error

**Cause**: SBOM attestation not found

**Solutions**:
1. Verify image was built from main branch (not PR or feature branch)
2. Check build date (SBOMs only generated after 2025-01-17)
3. Wait 30-60 seconds after push (attestation upload is asynchronous)

```bash
# Check if image has any attestations
cosign verify-attestation \
  --type https://spdx.dev/Document \
  ghcr.io/infobloxopen/ib-schema-registry:latest 2>&1 | grep -i attestation
```

### Empty or Invalid SBOM

**Cause**: SBOM generation failed or corrupted

**Solutions**:
1. Download SBOM from GitHub Actions artifacts as backup
2. Check workflow logs for SBOM generation errors
3. Verify jq is installed for SBOM extraction

```bash
# Validate SBOM JSON structure
cosign verify-attestation \
  --type https://spdx.dev/Document \
  --certificate-identity-regexp '^https://github.com/infobloxopen/ib-schema-registry/' \
  --certificate-oidc-issuer https://token.actions.githubusercontent.com \
  ghcr.io/infobloxopen/ib-schema-registry:latest \
  | jq -r '.payload | @base64d | fromjson | .predicate' | jq empty && echo "✅ Valid"
```

### Signature Verification Failed

**Cause**: Certificate identity or OIDC issuer mismatch

**Solutions**:
1. Ensure you're using the correct certificate identity pattern
2. Verify OIDC issuer is `https://token.actions.githubusercontent.com`
3. Check image was built from official repository

```bash
# Use regex pattern for flexibility
cosign verify-attestation \
  --type https://spdx.dev/Document \
  --certificate-identity-regexp '^https://github.com/infobloxopen/ib-schema-registry/' \
  --certificate-oidc-issuer https://token.actions.githubusercontent.com \
  ghcr.io/infobloxopen/ib-schema-registry:latest
```

## CI/CD Integration

### Kubernetes Admission Controller

Verify SBOM attestations before deploying to Kubernetes:

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: image-verification-policy
data:
  policy.yaml: |
    apiVersion: v1
    kind: Policy
    metadata:
      name: require-sbom-attestation
    spec:
      match:
        - apiVersion: v1
          kind: Pod
      validate:
        message: "Container images must have SBOM attestations"
        attestations:
          - predicateType: https://spdx.dev/Document
            issuer: https://token.actions.githubusercontent.com
            subject:
              - "ghcr.io/infobloxopen/ib-schema-registry*"
```

### GitOps Workflow

Add SBOM verification to ArgoCD or Flux:

```yaml
# argocd-app.yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: schema-registry
spec:
  source:
    repoURL: https://github.com/infobloxopen/ib-schema-registry
    targetRevision: main
    helm:
      values: |
        image:
          repository: ghcr.io/infobloxopen/ib-schema-registry
          tag: "latest"
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - Validate=true  # Validates SBOM attestation before deploy
```

### Docker Content Trust

Enable Docker Content Trust with SBOM verification:

```bash
# Enable DCT
export DOCKER_CONTENT_TRUST=1

# Verify and pull image
docker pull ghcr.io/infobloxopen/ib-schema-registry:latest

# Verify SBOM attestation
cosign verify-attestation \
  --type https://spdx.dev/Document \
  --certificate-identity-regexp '^https://github.com/infobloxopen/ib-schema-registry/' \
  --certificate-oidc-issuer https://token.actions.githubusercontent.com \
  ghcr.io/infobloxopen/ib-schema-registry:latest
```

## Compliance and Auditing

### Generate Attestation Report

Create a compliance report for auditors:

```bash
#!/bin/bash

IMAGE="ghcr.io/infobloxopen/ib-schema-registry:latest"
REPORT_FILE="attestation-report-$(date +%Y%m%d).md"

cat > "$REPORT_FILE" <<EOF
# Container Image Attestation Report

**Image**: $IMAGE
**Generated**: $(date)
**Verifier**: $(whoami)

## Build Provenance

\`\`\`json
$(cosign verify-attestation \
  --type slsaprovenance \
  --certificate-identity-regexp '^https://github.com/infobloxopen/ib-schema-registry/' \
  --certificate-oidc-issuer https://token.actions.githubusercontent.com \
  "$IMAGE" 2>/dev/null \
  | jq -r '.payload | @base64d | fromjson | .predicate' | head -20)
\`\`\`

## SBOM Summary

\`\`\`json
$(cosign verify-attestation \
  --type https://spdx.dev/Document \
  --certificate-identity-regexp '^https://github.com/infobloxopen/ib-schema-registry/' \
  --certificate-oidc-issuer https://token.actions.githubusercontent.com \
  "$IMAGE" 2>/dev/null \
  | jq -r '.payload | @base64d | fromjson | .predicate' | jq '{
    name, spdxVersion, 
    packageCount: (.packages | length),
    created: .creationInfo.created
  }')
\`\`\`

## Verification Status

- ✅ Build provenance verified
- ✅ SBOM attestation verified
- ✅ Cryptographic binding confirmed
- ✅ Trusted builder identity validated

EOF

echo "Report generated: $REPORT_FILE"
```

## Best Practices

### For Security Teams

1. **Verify before deployment**: Always verify SBOM attestations before deploying to production
2. **Automate scanning**: Set up automated vulnerability scanning using SBOM
3. **Monitor dependencies**: Track SBOM changes across releases to detect unexpected dependency changes
4. **Archive SBOMs**: Download and archive SBOMs from GitHub Actions artifacts for compliance

### For Operations Teams

1. **Pin by digest**: Use image digests instead of tags for immutable references
2. **Verify in CI/CD**: Add SBOM verification to deployment pipelines
3. **Document procedures**: Maintain runbooks for SBOM verification and incident response
4. **Regular audits**: Periodically verify SBOM attestations for deployed images

### For Compliance Teams

1. **Track licenses**: Extract and review license information from SBOMs
2. **Maintain reports**: Generate and archive attestation reports
3. **Audit trail**: Document all SBOM verifications in compliance logs
4. **Retention policy**: Archive SBOMs beyond the 90-day GitHub Actions retention period

## Additional Resources

- **SLSA Framework**: https://slsa.dev/
- **SPDX Specification**: https://spdx.dev/specifications/
- **CycloneDX Specification**: https://cyclonedx.org/specification/overview/
- **Sigstore/Cosign Docs**: https://docs.sigstore.dev/
- **GitHub Attestations**: https://docs.github.com/en/actions/security-guides/using-artifact-attestations
- **Syft SBOM Tool**: https://github.com/anchore/syft

## Support

For questions or issues:
- **GitHub Issues**: https://github.com/infobloxopen/ib-schema-registry/issues
- **Security Concerns**: Report via GitHub Security Advisories
- **Documentation**: See [docs/](../docs/) directory

---

**Related Documentation**:
- [Provenance Verification Guide](./provenance-verification.md)
- [Registry Attestation Limits](./registry-attestation-limits.md)
- [Troubleshooting Provenance](./troubleshooting-provenance.md)
