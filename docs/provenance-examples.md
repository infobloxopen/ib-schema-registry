# Provenance Attestation Query Examples

**Purpose**: Practical examples for inspecting and querying SLSA provenance attestations  
**Date**: 2025-01-17  
**Audience**: Developers, security engineers, operations teams

## Overview

This guide provides copy-paste examples for common provenance inspection tasks. All examples use standard tools (cosign, docker buildx, jq) and work with SLSA provenance attestations generated by this repository.

## Prerequisites

```bash
# Install required tools
go install github.com/sigstore/cosign/v2/cmd/cosign@latest  # Signature verification
brew install jq  # JSON parsing (or apt-get install jq on Linux)

# Ensure Docker buildx is available
docker buildx version
```

## Basic Queries

### Check if Provenance Exists

```bash
IMAGE="ghcr.io/infobloxopen/ib-schema-registry:main"

# Quick check with docker buildx
if docker buildx imagetools inspect "$IMAGE" --format '{{json .Provenance}}' \
   | jq -e '.SLSA' > /dev/null 2>&1; then
  echo "✅ Provenance attestation exists"
else
  echo "❌ No provenance attestation found"
fi
```

### Download Provenance

```bash
IMAGE="ghcr.io/infobloxopen/ib-schema-registry:main"

# Download all attestations (includes signature)
cosign download attestation "$IMAGE" > attestations.json

# Download and extract provenance only
cosign download attestation "$IMAGE" \
  | jq -r '.payload | @base64d | fromjson | .predicate' \
  > provenance.json

# View provenance
cat provenance.json | jq '.'
```

### View Provenance Summary

```bash
IMAGE="ghcr.io/infobloxopen/ib-schema-registry:main"

# Extract key fields
cosign download attestation "$IMAGE" \
  | jq -r '.payload | @base64d | fromjson | {
      type: .predicateType,
      source: .predicate.invocation.configSource.uri,
      commit: .predicate.invocation.configSource.digest.sha1,
      builder: .predicate.builder.id,
      buildTime: .predicate.metadata.buildStartedOn
    }'

# Example output:
# {
#   "type": "https://slsa.dev/provenance/v1",
#   "source": "git+https://github.com/infobloxopen/ib-schema-registry",
#   "commit": "abc123def456...",
#   "builder": "https://github.com/docker/build-push-action@v5",
#   "buildTime": "2025-01-17T10:30:00Z"
# }
```

## Source Verification Queries

### Extract Source Repository

```bash
IMAGE="ghcr.io/infobloxopen/ib-schema-registry:main"

# Get source repository URL
cosign download attestation "$IMAGE" \
  | jq -r '.payload | @base64d | fromjson | .predicate.invocation.configSource.uri'

# Example output: git+https://github.com/infobloxopen/ib-schema-registry
```

### Extract Commit SHA

```bash
IMAGE="ghcr.io/infobloxopen/ib-schema-registry:main"

# Get commit SHA
cosign download attestation "$IMAGE" \
  | jq -r '.payload | @base64d | fromjson | .predicate.invocation.configSource.digest.sha1'

# Example output: abc123def456...
```

### Verify Commit Matches Tag

```bash
IMAGE="ghcr.io/infobloxopen/ib-schema-registry:v1.0.0"
EXPECTED_TAG="v1.0.0"

# Get commit from attestation
ATTESTATION_COMMIT=$(cosign download attestation "$IMAGE" \
  | jq -r '.payload | @base64d | fromjson | .predicate.invocation.configSource.digest.sha1')

# Get commit for tag from GitHub API
TAG_COMMIT=$(curl -s https://api.github.com/repos/infobloxopen/ib-schema-registry/git/refs/tags/${EXPECTED_TAG} \
  | jq -r '.object.sha')

if [ "$ATTESTATION_COMMIT" = "$TAG_COMMIT" ]; then
  echo "✅ Commit matches tag $EXPECTED_TAG"
else
  echo "❌ Commit mismatch!"
  echo "  Attestation: $ATTESTATION_COMMIT"
  echo "  Tag:         $TAG_COMMIT"
fi
```

### Extract Build Arguments

```bash
IMAGE="ghcr.io/infobloxopen/ib-schema-registry:main"

# Get all build arguments
cosign download attestation "$IMAGE" \
  | jq -r '.payload | @base64d | fromjson | .predicate.invocation.parameters.args'

# Example output:
# {
#   "SOURCE_REPOSITORY": "https://github.com/infobloxopen/ib-schema-registry",
#   "SOURCE_COMMIT": "abc123...",
#   "BUILD_WORKFLOW": "Build Multi-Arch Schema Registry Image@refs/heads/main"
# }
```

## Build Metadata Queries

### Extract Builder Information

```bash
IMAGE="ghcr.io/infobloxopen/ib-schema-registry:main"

# Get builder identity
cosign download attestation "$IMAGE" \
  | jq -r '.payload | @base64d | fromjson | .predicate.builder'

# Example output:
# {
#   "id": "https://github.com/docker/build-push-action@v5"
# }
```

### Extract Build Timestamps

```bash
IMAGE="ghcr.io/infobloxopen/ib-schema-registry:main"

# Get build start and finish times
cosign download attestation "$IMAGE" \
  | jq -r '.payload | @base64d | fromjson | .predicate.metadata | {
      started: .buildStartedOn,
      finished: .buildFinishedOn,
      duration: (.buildFinishedOn | fromdateiso8601) - (.buildStartedOn | fromdateiso8601) | tostring + "s"
    }'

# Example output:
# {
#   "started": "2025-01-17T10:30:00Z",
#   "finished": "2025-01-17T10:45:00Z",
#   "duration": "900s"
# }
```

### Check Build Completeness

```bash
IMAGE="ghcr.io/infobloxopen/ib-schema-registry:main"

# Get completeness indicators
cosign download attestation "$IMAGE" \
  | jq -r '.payload | @base64d | fromjson | .predicate.metadata.completeness'

# Example output:
# {
#   "parameters": true,
#   "environment": false,
#   "materials": false
# }
```

## Materials Queries

### List All Build Materials

```bash
IMAGE="ghcr.io/infobloxopen/ib-schema-registry:main"

# Get all materials (source, base images, etc.)
cosign download attestation "$IMAGE" \
  | jq -r '.payload | @base64d | fromjson | .predicate.materials'

# Pretty print with types
cosign download attestation "$IMAGE" \
  | jq -r '.payload | @base64d | fromjson | .predicate.materials[] | {
      uri: .uri,
      digest: .digest
    }'
```

### Extract Base Images

```bash
IMAGE="ghcr.io/infobloxopen/ib-schema-registry:main"

# Get base images (OCI image references)
cosign download attestation "$IMAGE" \
  | jq -r '.payload | @base64d | fromjson | .predicate.materials[] | 
    select(.uri | startswith("pkg:docker") or startswith("docker-image")) |
    {uri, digest}'

# Example output:
# {
#   "uri": "pkg:docker/eclipse-temurin@sha256:...",
#   "digest": {"sha256": "..."}
# }
```

### Check for Specific Dependencies

```bash
IMAGE="ghcr.io/infobloxopen/ib-schema-registry:main"
SEARCH_PATTERN="chainguard"

# Search for specific material
cosign download attestation "$IMAGE" \
  | jq -r '.payload | @base64d | fromjson | .predicate.materials[] | 
    select(.uri | contains("'$SEARCH_PATTERN'"))'
```

## Multi-Architecture Queries

### List Architectures

```bash
IMAGE="ghcr.io/infobloxopen/ib-schema-registry:main"

# Get all architectures
docker buildx imagetools inspect "$IMAGE" \
  | grep "Platform:" | awk '{print $2}'

# Or with JSON output
docker buildx imagetools inspect "$IMAGE" --format '{{json .Manifest}}' \
  | jq -r '.manifests[] | "\(.platform.os)/\(.platform.architecture)"'

# Example output:
# linux/amd64
# linux/arm64
```

### Get Digest for Specific Architecture

```bash
IMAGE="ghcr.io/infobloxopen/ib-schema-registry:main"
PLATFORM="linux/amd64"

# Get architecture-specific digest
ARCH_DIGEST=$(docker buildx imagetools inspect "$IMAGE" --format '{{json .Manifest}}' \
  | jq -r --arg plat "$PLATFORM" '.manifests[] | 
    select(.platform.os + "/" + .platform.architecture == $plat) | .digest')

echo "Digest for $PLATFORM: $ARCH_DIGEST"
```

### Verify Each Architecture

```bash
IMAGE="ghcr.io/infobloxopen/ib-schema-registry:main"

# Verify both architectures
for platform in "linux/amd64" "linux/arm64"; do
  echo "Verifying $platform..."
  if cosign verify-attestation \
    --type slsaprovenance \
    --certificate-identity-regexp '^https://github.com/infobloxopen/ib-schema-registry/' \
    --certificate-oidc-issuer https://token.actions.githubusercontent.com \
    --platform "$platform" \
    "$IMAGE" > /dev/null 2>&1; then
    echo "✅ $platform: Provenance verified"
  else
    echo "❌ $platform: Verification failed"
  fi
done
```

## Compliance Queries

### Generate Audit Report

```bash
IMAGE="ghcr.io/infobloxopen/ib-schema-registry:v1.0.0"
OUTPUT_FILE="audit-report-$(date +%Y%m%d-%H%M%S).json"

# Generate comprehensive audit report
cosign verify-attestation \
  --type slsaprovenance \
  --certificate-identity-regexp '^https://github.com/infobloxopen/ib-schema-registry/' \
  --certificate-oidc-issuer https://token.actions.githubusercontent.com \
  "$IMAGE" \
  | jq '{
      auditTimestamp: now | todate,
      imageReference: "'$IMAGE'",
      verificationStatus: "PASSED",
      provenance: (.payload | @base64d | fromjson | .predicate | {
        source: {
          repository: .invocation.configSource.uri,
          commit: .invocation.configSource.digest.sha1,
          buildWorkflow: .invocation.parameters.args.BUILD_WORKFLOW
        },
        builder: .builder.id,
        buildType: .buildType,
        buildTime: {
          started: .metadata.buildStartedOn,
          finished: .metadata.buildFinishedOn
        },
        materials: .materials | map({uri, digest}),
        completeness: .metadata.completeness
      }),
      signature: {
        verified: true,
        oidcIssuer: "https://token.actions.githubusercontent.com",
        certificateIdentity: "GitHub Actions"
      }
    }' > "$OUTPUT_FILE"

echo "Audit report saved to: $OUTPUT_FILE"
```

### Extract SLSA Level Indicators

```bash
IMAGE="ghcr.io/infobloxopen/ib-schema-registry:main"

# Check SLSA level indicators
cosign download attestation "$IMAGE" \
  | jq -r '.payload | @base64d | fromjson | {
      predicateType: .predicateType,
      buildType: .predicate.buildType,
      builderVerified: (.predicate.builder.id | contains("github.com")),
      parametersComplete: .predicate.metadata.completeness.parameters,
      reproducible: .predicate.metadata.reproducible // false
    }'

# Example output:
# {
#   "predicateType": "https://slsa.dev/provenance/v1",
#   "buildType": "https://mobyproject.org/buildkit@v1",
#   "builderVerified": true,
#   "parametersComplete": true,
#   "reproducible": false
# }
```

### Check for Required Fields

```bash
IMAGE="ghcr.io/infobloxopen/ib-schema-registry:main"

# Verify all required SLSA fields are present
PROVENANCE=$(cosign download attestation "$IMAGE" | jq -r '.payload | @base64d | fromjson')

echo "Checking required SLSA provenance fields..."

# Check predicate type
if echo "$PROVENANCE" | jq -e '.predicateType | contains("slsa.dev/provenance")' > /dev/null; then
  echo "✅ Predicate type: Valid"
else
  echo "❌ Predicate type: Missing or invalid"
fi

# Check builder
if echo "$PROVENANCE" | jq -e '.predicate.builder.id' > /dev/null; then
  echo "✅ Builder ID: Present"
else
  echo "❌ Builder ID: Missing"
fi

# Check source
if echo "$PROVENANCE" | jq -e '.predicate.invocation.configSource' > /dev/null; then
  echo "✅ Source config: Present"
else
  echo "❌ Source config: Missing"
fi

# Check materials
if echo "$PROVENANCE" | jq -e '.predicate.materials | length > 0' > /dev/null; then
  echo "✅ Materials: Present"
else
  echo "❌ Materials: Missing"
fi
```

## Advanced Queries

### Compare Two Images

```bash
IMAGE1="ghcr.io/infobloxopen/ib-schema-registry:v1.0.0"
IMAGE2="ghcr.io/infobloxopen/ib-schema-registry:v1.1.0"

# Compare source commits
COMMIT1=$(cosign download attestation "$IMAGE1" | jq -r '.payload | @base64d | fromjson | .predicate.invocation.configSource.digest.sha1')
COMMIT2=$(cosign download attestation "$IMAGE2" | jq -r '.payload | @base64d | fromjson | .predicate.invocation.configSource.digest.sha1')

echo "Commit comparison:"
echo "  v1.0.0: $COMMIT1"
echo "  v1.1.0: $COMMIT2"

if [ "$COMMIT1" = "$COMMIT2" ]; then
  echo "⚠️  Same commit (possibly just rebuild)"
else
  echo "✅ Different commits (code changes)"
fi
```

### Extract Certificate Information

```bash
IMAGE="ghcr.io/infobloxopen/ib-schema-registry:main"

# Verify and extract certificate details
cosign verify-attestation \
  --type slsaprovenance \
  --certificate-identity-regexp '^https://github.com/infobloxopen/ib-schema-registry/' \
  --certificate-oidc-issuer https://token.actions.githubusercontent.com \
  "$IMAGE" 2>&1 | grep -A 20 "Certificate:"

# Example output shows:
# - Subject
# - Issuer  
# - Not Before / Not After
# - SANs (Subject Alternative Names)
```

### Search for Specific Build Argument

```bash
IMAGE="ghcr.io/infobloxopen/ib-schema-registry:main"
ARG_NAME="SOURCE_COMMIT"

# Extract specific build argument
cosign download attestation "$IMAGE" \
  | jq -r --arg arg "$ARG_NAME" \
    '.payload | @base64d | fromjson | .predicate.invocation.parameters.args[$arg]'

# Example output: abc123def456...
```

## Scripting Examples

### Batch Verification

```bash
#!/bin/bash
# Verify multiple images

IMAGES=(
  "ghcr.io/infobloxopen/ib-schema-registry:main"
  "ghcr.io/infobloxopen/ib-schema-registry:v1.0.0"
  "ghcr.io/infobloxopen/ib-schema-registry:latest"
)

for image in "${IMAGES[@]}"; do
  echo "Verifying: $image"
  if cosign verify-attestation \
    --type slsaprovenance \
    --certificate-identity-regexp '^https://github.com/infobloxopen/ib-schema-registry/' \
    --certificate-oidc-issuer https://token.actions.githubusercontent.com \
    "$image" > /dev/null 2>&1; then
    echo "✅ Verified"
  else
    echo "❌ Failed"
  fi
  echo ""
done
```

### Export Provenance to CSV

```bash
#!/bin/bash
# Export provenance metadata to CSV

IMAGE="ghcr.io/infobloxopen/ib-schema-registry:main"
OUTPUT="provenance.csv"

echo "image,source,commit,builder,buildTime" > "$OUTPUT"

cosign download attestation "$IMAGE" \
  | jq -r '.payload | @base64d | fromjson | 
    [
      "'$IMAGE'",
      .predicate.invocation.configSource.uri,
      .predicate.invocation.configSource.digest.sha1,
      .predicate.builder.id,
      .predicate.metadata.buildStartedOn
    ] | @csv' >> "$OUTPUT"

echo "Exported to: $OUTPUT"
cat "$OUTPUT"
```

## Additional Resources

- **jq Manual**: https://stedolan.github.io/jq/manual/
- **Cosign Documentation**: https://docs.sigstore.dev/cosign/overview/
- **SLSA Provenance Spec**: https://slsa.dev/provenance/v1
- **Docker Buildx**: https://docs.docker.com/build/attestations/

## Tips and Tricks

### Pretty Print JSON

```bash
# Use jq for colored, formatted output
cosign download attestation "$IMAGE" | jq '.'

# Use jq -C for colored output in pipes
cosign download attestation "$IMAGE" | jq -C '.' | less -R
```

### Save Attestation for Offline Analysis

```bash
# Download once, analyze many times
cosign download attestation "$IMAGE" > attestation.json

# Then query locally
cat attestation.json | jq -r '.payload | @base64d | fromjson | .predicate.builder.id'
cat attestation.json | jq -r '.payload | @base64d | fromjson | .predicate.invocation.configSource.uri'
```

### Filter Large Attestations

```bash
# Extract only specific fields to reduce output
cosign download attestation "$IMAGE" \
  | jq -r '.payload | @base64d | fromjson | {
      type: .predicateType,
      source: .predicate.invocation.configSource.uri,
      commit: .predicate.invocation.configSource.digest.sha1
    }'
```
