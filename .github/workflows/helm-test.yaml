name: Helm Chart Tests

on:
  workflow_run:
    workflows: ["Build Multi-Arch Schema Registry Image"]
    types:
      - completed
  workflow_dispatch:

jobs:
  lint:
    name: Lint Helm Chart
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: '3.13.0'

      - name: Lint Helm chart
        run: helm lint helm/ib-schema-registry/

  e2e-test:
    name: E2E Tests
    runs-on: ${{ matrix.os }}
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    strategy:
      matrix:
        os: [ubuntu-latest]
        # Future: Add macos-latest for ARM testing
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: '3.13.0'

      - name: Install k3d
        run: |
          curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull Docker image from GHCR
        run: |
          # Use the commit SHA from the workflow that triggered this run
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            IMAGE_TAG="ghcr.io/${{ github.repository }}:main"
          else
            IMAGE_TAG="ghcr.io/${{ github.repository }}:sha-${{ github.event.workflow_run.head_sha }}"
          fi
          echo "Pulling image: $IMAGE_TAG"
          docker pull "$IMAGE_TAG"
          
          # Tag as 'test' for E2E tests
          docker tag "$IMAGE_TAG" "ib-schema-registry:test"

      - name: Run E2E tests
        run: bash tests/e2e/test-helm-chart.sh

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Cluster info ==="
          kubectl cluster-info || true
          echo "=== Pods ==="
          kubectl get pods -A || true
          echo "=== Events ==="
          kubectl get events -A --sort-by='.lastTimestamp' || true
          echo "=== Schema Registry logs ==="
          kubectl logs -l app.kubernetes.io/name=ib-schema-registry --tail=100 || true

  package:
    name: Package Helm Chart
    runs-on: ubuntu-latest
    needs: [lint, e2e-test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: '3.13.0'

      - name: Package Helm chart
        run: |
          CHART_VERSION=$(grep '^version:' helm/ib-schema-registry/Chart.yaml | awk '{print $2}')
          helm package helm/ib-schema-registry/ --version "$CHART_VERSION"
          echo "CHART_VERSION=$CHART_VERSION" >> $GITHUB_ENV

      - name: Upload chart artifact
        uses: actions/upload-artifact@v4
        with:
          name: helm-chart
          path: ib-schema-registry-${{ env.CHART_VERSION }}.tgz
          retention-days: 30

  # Future: Publish to OCI registry on release tags
  # publish:
  #   name: Publish to GHCR
  #   runs-on: ubuntu-latest
  #   needs: [package]
  #   if: startsWith(github.ref, 'refs/tags/v')
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #
  #     - name: Set up Helm
  #       uses: azure/setup-helm@v3
  #       with:
  #         version: '3.13.0'
  #
  #     - name: Login to GHCR
  #       run: echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io -u ${{ github.actor }} --password-stdin
  #
  #     - name: Push chart to GHCR
  #       run: |
  #         CHART_VERSION=$(grep '^version:' helm/ib-schema-registry/Chart.yaml | awk '{print $2}')
  #         helm package helm/ib-schema-registry/ --version "$CHART_VERSION"
  #         helm push ib-schema-registry-$CHART_VERSION.tgz oci://ghcr.io/${{ github.repository_owner }}
