# Data Model: SBOM Generation and Storage

**Date**: 2026-01-17  
**Purpose**: Define data structures, file formats, and relationships for SBOM caching and idempotency

## Overview

The SBOM generation system manages Software Bill of Materials artifacts indexed by container image digest. The system detects existing SBOMs, verifies content identity, and updates only when necessary.

## Core Entities

### 1. SBOM File (Artifact)

**Definition**: A Software Bill of Materials document in SPDX or CycloneDX format, generated by Syft.

**Attributes**:
- `format`: Enum [`cyclonedx-json`, `spdx-json`]
- `image_ref`: Container image reference (e.g., `ib-schema-registry:7.6.1`)
- `platform`: Architecture target (e.g., `linux/amd64`, `linux/arm64`)
- `content`: JSON document containing component list, versions, licenses
- `content_hash`: SHA256 hash of SBOM file (for idempotency verification)
- `file_size_bytes`: Byte count of serialized SBOM
- `generated_at`: ISO 8601 timestamp of generation

**Storage Location**: `build/sbom/[image-tag]-[arch].[format].json`

**Example Path**: `build/sbom/7.6.1-amd64.cyclonedx.json`

---

### 2. SBOM Metadata (Index)

**Definition**: Auxiliary metadata about SBOM artifact, stored alongside SBOM file for caching decisions.

**Attributes**:
- `image`: Full image reference (e.g., `ghcr.io/infobloxopen/ib-schema-registry:7.6.1`)
- `digest`: Image digest in canonical form (e.g., `sha256:a9f36f222baa73fd...`)
- `platform`: Architecture (e.g., `linux/amd64`)
- `format`: SBOM format (e.g., `cyclonedx-json`)
- `generated_at`: ISO 8601 timestamp of last generation
- `tool`: SBOM generator tool (e.g., `syft`)
- `tool_version`: Version of generator tool (e.g., `1.0.0`)
- `content_hash`: SHA256 hash of SBOM file
- `operation`: Generation operation type (see below)
- `file_size_bytes`: SBOM file size
- `output_file`: Relative path to SBOM artifact

**Storage Location**: `build/sbom/[image-tag]-[arch].metadata.json`

**Example Path**: `build/sbom/7.6.1-amd64.metadata.json`

**Serialization Format**: JSON

```json
{
  "image": "ghcr.io/infobloxopen/ib-schema-registry:7.6.1",
  "digest": "sha256:a9f36f222baa73fd5590d4648446f9632a2db54e3e0f601994986440f232b249",
  "platform": "linux/amd64",
  "format": "cyclonedx-json",
  "generated_at": "2026-01-17T10:30:45Z",
  "tool": "syft",
  "tool_version": "1.0.0",
  "content_hash": "sha256:b8c47e555caa84ge6691e5759557d3cf3e3fc65e5f611993988552330g343350",
  "operation": "GENERATED",
  "file_size_bytes": 15234,
  "output_file": "build/sbom/7.6.1-amd64.cyclonedx.json"
}
```

---

### 3. Image Digest

**Definition**: Unique identifier for a container image at a specific platform/architecture.

**Properties**:
- **Format**: SHA256 hex string with `sha256:` prefix
- **Length**: 71 characters total (8 + 64 hex digits)
- **Uniqueness**: Per image, per architecture (linux/amd64 and linux/arm64 have distinct digests)
- **Stability**: Deterministic - same source/dependencies produce same digest

**Example**: `sha256:a9f36f222baa73fd5590d4648446f9632a2db54e3e0f601994986440f232b249`

**Derivation**: Computed by Docker/containerd when image is built or pulled

**Usage in SBOM**:
- Primary key for deduplication and idempotency checking
- Stored in metadata.json for audit and verification
- Provides audit trail (digest captures exact state of image)

---

## Operations

### Operation Type: GENERATED

**Definition**: SBOM was newly created (no prior artifact existed).

**Conditions**:
- No metadata.json file found for this image/platform/format
- No existing SBOM file found

**Output**: 
- New SBOM file created
- Metadata.json written with `operation: "GENERATED"`

**Exit Code**: 0 (success)

**User Message**: "SBOM generated successfully"

---

### Operation Type: VERIFIED_IDENTICAL

**Definition**: SBOM regenerated and verified to be identical to existing version.

**Conditions**:
- Metadata.json file exists with stored `content_hash`
- New SBOM generated from image
- New SBOM content_hash matches stored content_hash

**Output**:
- Existing SBOM file **not overwritten**
- Metadata.json updated only with new `generated_at` timestamp
- metadata.json `operation: "VERIFIED_IDENTICAL"`

**Exit Code**: 0 (success)

**User Message**: "SBOM verified identical (no changes)"

---

### Operation Type: UPDATED

**Definition**: SBOM regenerated with different content (image changed).

**Conditions**:
- Metadata.json file exists with stored `content_hash`
- New SBOM generated from image
- New SBOM content_hash differs from stored content_hash

**Output**:
- Existing SBOM file **replaced** with new version
- Metadata.json updated with new `content_hash`, `generated_at`, `digest`
- metadata.json `operation: "UPDATED"`

**Exit Code**: 0 (success)

**User Message**: "SBOM updated (image changed)"

---

## File Structure

```
build/sbom/
├── 7.6.1-amd64.cyclonedx.json          # CycloneDX SBOM for amd64
├── 7.6.1-amd64.cyclonedx.metadata.json # Metadata: digest, hash, operation
├── 7.6.1-amd64.spdx.json               # SPDX SBOM for amd64
├── 7.6.1-amd64.spdx.metadata.json      # Metadata: digest, hash, operation
├── 7.6.1-arm64.cyclonedx.json          # CycloneDX SBOM for arm64
├── 7.6.1-arm64.cyclonedx.metadata.json # Metadata: digest, hash, operation
├── 7.6.1-arm64.spdx.json               # SPDX SBOM for arm64
└── 7.6.1-arm64.spdx.metadata.json      # Metadata: digest, hash, operation
```

**Notes**:
- Metadata filename derived from SBOM filename: `[sbom].metadata.json`
- Architecture identifier (`amd64`, `arm64`) indexes per-platform artifacts
- Format suffix (`cyclonedx`, `spdx`) distinguishes SBOM formats
- No per-registry directories (registry is part of image reference, stored in metadata)

---

## Relationships

```
Image (referenced by tag)
  ↓
  Contains → Digest (sha256 hash, unique per platform)
  ↓
  Generates → SBOM File (cyclonedx-json or spdx-json)
  ↓
  Has → Metadata (indexed by content_hash for idempotency)
```

---

## Validation Rules

### SBOM File Validation
1. File MUST exist at path
2. File MUST be valid JSON
3. SBOM format (CycloneDX or SPDX) MUST be valid per specification
4. File size MUST match declared `file_size_bytes` in metadata

### Metadata File Validation
1. File MUST be valid JSON
2. All required fields MUST be present (non-null)
3. `operation` field MUST be one of: `GENERATED`, `VERIFIED_IDENTICAL`, `UPDATED`
4. `digest` format MUST be `sha256:[64 hex chars]`
5. `content_hash` format MUST be `sha256:[64 hex chars]`
6. `platform` MUST be `linux/amd64` or `linux/arm64`
7. `generated_at` MUST be valid ISO 8601 timestamp

### Idempotency Check Validation
1. If metadata.json exists, read `content_hash`
2. Generate new SBOM
3. Compute hash of new SBOM
4. Compare: if hashes match → `VERIFIED_IDENTICAL`, if different → `UPDATED`
5. If metadata.json doesn't exist → `GENERATED`

