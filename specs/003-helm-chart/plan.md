# Implementation Plan: Helm Chart for Kubernetes Deployment

**Branch**: `003-helm-chart` | **Date**: 2026-01-16 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/003-helm-chart/spec.md`

**Note**: This plan is generated by the `/speckit.plan` command following the speckit workflow.

## Summary

Create a production-ready Helm chart for deploying Confluent Schema Registry to Kubernetes clusters with high availability features, automated configuration management, and comprehensive end-to-end testing. The chart will support multi-replica deployments with pod distribution across availability zones, automatic rolling updates triggered by configuration changes, and packaging as an OCI artifact for unified artifact management alongside container images.

## Technical Context

**Language/Version**: YAML (Helm templates), Bash/Shell scripting for e2e tests  
**Primary Dependencies**: 
- Helm 3.8+ (for OCI chart support)
- kubectl 1.24+ (Kubernetes API compatibility)
- k3d 5.x (lightweight Kubernetes for e2e testing)
- Redpanda (Kafka-compatible backend for e2e tests)

**Storage**: N/A (Schema Registry is stateless; state stored in Kafka)  
**Testing**: 
- Helm test framework for basic validation
- Bash scripts for e2e validation (cluster setup, deployment, API testing)
- curl/jq for REST API validation

**Target Platform**: Kubernetes 1.24+ (stable APIs: apps/v1, v1, policy/v1)  
**Project Type**: Kubernetes Helm chart (template-based configuration)  
**Performance Goals**: 
- Chart deployment completes in <2 minutes
- Schema Registry pods ready within 1 minute of creation
- Rolling update triggered within 30 seconds of configuration change

**Constraints**: 
- MUST work with distroless runtime images (no shell in container)
- MUST support multi-arch images (linux/amd64, linux/arm64)
- MUST be pluggable with different base images via values
- MUST run as non-root (UID 65532)
- MUST include comprehensive values.yaml documentation

**Scale/Scope**: 
- Support 1-10 replica deployments
- Single-namespace deployment per Helm release
- Comprehensive values.yaml (~100-150 parameters with documentation)
- E2E test suite validates full deployment lifecycle

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

- [x] **Multi-arch portability**: Helm chart is platform-agnostic YAML; references multi-arch container images from Feature 001; e2e tests run identically on macOS ARM and Linux x86 via k3d.
- [x] **Base image pluggability**: Chart's values.yaml allows configuring image.repository, image.tag, and image.pullPolicy; no hardcoded image references that prevent swapping base images.
- [x] **Distroless compatibility**: Chart does not require shell in containers; uses exec-form ENTRYPOINT from container image (built in Feature 001); no `/bin/sh -c` commands in templates.
- [x] **Supply-chain security**: 
  - [x] References non-root container image (UID 65532) from Feature 001; chart configures securityContext.runAsNonRoot: true.
  - [x] No curl/wget downloads in chart templates; all dependencies managed via Helm/Kubernetes APIs.
  - [x] Chart templates include OCI labels (`org.opencontainers.image.*` annotations) propagated to pods.
  - [x] Image references configurable via values; supports digest-based pinning through values.yaml.
- [x] **Licensing compliance**: Helm chart is original work (MIT licensed in repo); no upstream Confluent code copied; README includes compliance section referencing upstream Schema Registry licenses.
- [x] **Repository ergonomics**: 
  - [x] Chart includes standard Helm structure (Chart.yaml, values.yaml, templates/, README.md).
  - [x] `helm install` and `helm test` commands documented in chart README.
  - [x] E2E test scripts documented with prerequisites and usage examples.
- [x] **Testing validation**: 
  - [x] E2E tests create k3d cluster on both linux/amd64 and linux/arm64 (CI matrix).
  - [x] Tests validate basic deployment without requiring full production Kafka (uses Redpanda).
  - [x] Smoke tests verify Schema Registry API responds (`GET /subjects` returns 200).

**Violations**: None. This feature fully complies with the constitution:
- Helm charts were explicitly listed as "Out of Scope (Milestone 1)" but constitution allows for "future milestones"—this is Milestone 2.
- Feature 001 (container image) provides the compliant base image that this chart deploys.
- Chart itself introduces no new compliance issues (no build tooling, no base images, pure Kubernetes configuration).

## Project Structure

### Documentation (this feature)

```text
specs/003-helm-chart/
├── plan.md              # This file (Phase 0 setup + planning)
├── research.md          # Phase 0: Helm best practices, k3d setup, Redpanda integration
├── data-model.md        # Phase 1: Kubernetes resources, values schema, ConfigMap structure
├── quickstart.md        # Phase 1: Quick deployment guide for operators
├── contracts/           # Phase 1: Example values.yaml, NOTES.txt template
│   ├── values-minimal.yaml
│   ├── values-ha.yaml
│   └── notes-template.txt
└── tasks.md             # Phase 2: Implementation tasks (NOT created by /speckit.plan)
```

### Source Code (repository root)

```text
chart/                                  # NEW: Helm chart root directory
├── Chart.yaml                          # Chart metadata (version, appVersion, dependencies)
├── values.yaml                         # Default configuration with inline documentation
├── README.md                           # Chart usage guide (helm install, configuration)
├── templates/                          # Kubernetes manifest templates
│   ├── NOTES.txt                       # Post-install instructions
│   ├── _helpers.tpl                    # Template helper functions
│   ├── configmap.yaml                  # Schema Registry configuration properties
│   ├── deployment.yaml                 # Main Schema Registry deployment
│   ├── service.yaml                    # ClusterIP service for internal access
│   ├── serviceaccount.yaml             # Service account for pods
│   ├── poddisruptionbudget.yaml        # HA: Prevents too many concurrent evictions
│   └── tests/                          # Helm test hook for basic validation
│       └── test-connection.yaml        # Tests API connectivity after install
└── .helmignore                         # Files to exclude from chart package

tests/                                  # EXISTING: Extended with e2e tests
├── smoke.sh                            # EXISTING: Container smoke tests
└── e2e/                                # NEW: End-to-end Kubernetes tests
    ├── README.md                       # E2E test documentation and prerequisites
    ├── test-helm-chart.sh              # Main e2e test orchestrator
    ├── setup-k3d-cluster.sh            # Creates k3d cluster with Redpanda
    ├── deploy-redpanda.sh              # Deploys Redpanda as Kafka backend
    ├── validate-schema-registry.sh     # API validation tests (register/retrieve schemas)
    └── teardown.sh                     # Cleanup k3d cluster and resources

.github/workflows/                      # EXISTING: Extended with Helm CI
├── build.yaml                          # EXISTING: Container image build
└── helm-test.yaml                      # NEW: Helm chart validation and e2e tests

Makefile                                # EXISTING: Extended with Helm targets
# New targets:
#   make helm-lint          - Validate chart syntax
#   make helm-package       - Package chart as .tgz
#   make helm-push          - Push chart to OCI registry
#   make helm-test-e2e      - Run e2e tests with k3d
```

**Structure Decision**: Single Helm chart at repository root under `chart/` directory. This follows the monorepo pattern where container image (Feature 001) and Helm chart (Feature 003) coexist. Chart references the container image built by Feature 001 via configurable `image.repository` and `image.tag` in values.yaml. E2E tests in `tests/e2e/` validate the complete deployment lifecycle.

## Complexity Tracking

> **This section intentionally left empty - No constitution violations to justify**

All constitution requirements are satisfied without exceptions:
- Chart is pure YAML templates (platform-agnostic)
- References compliant multi-arch container image from Feature 001
- No new build tooling or base image decisions
- Maintains all security and licensing invariants

---

## Phase 0 & 1 Completion Summary

### Phase 0: Research ✅

All technical unknowns resolved in [research.md](research.md):
1. Helm chart best practices for stateless applications
2. ConfigMap checksum pattern for rolling updates
3. PodDisruptionBudget sizing for HA
4. TopologySpreadConstraints configuration
5. JVM container memory detection
6. values.yaml documentation strategy
7. E2E testing with k3d and Redpanda
8. Helm chart OCI packaging workflow

### Phase 1: Design ✅

Design artifacts created:
- **[data-model.md](data-model.md)**: Kubernetes resources, values schema, configuration structure
- **[contracts/values-minimal.yaml](contracts/values-minimal.yaml)**: Single-replica development configuration
- **[contracts/values-ha.yaml](contracts/values-ha.yaml)**: Multi-replica production configuration with HA features
- **[contracts/notes-template.txt](contracts/notes-template.txt)**: Post-installation instructions template
- **[quickstart.md](quickstart.md)**: Operator deployment guide with examples

### Constitution Re-Check (Post-Design) ✅

All constitution requirements remain satisfied after Phase 1 design:

- ✅ **Multi-arch portability**: Chart templates are platform-agnostic YAML; references multi-arch images via configurable values
- ✅ **Base image pluggability**: `image.repository` and `image.tag` fully configurable; no hardcoded references
- ✅ **Distroless compatibility**: No shell commands in templates; respects container ENTRYPOINT from base image
- ✅ **Supply-chain security**: 
  - ✅ References non-root image (UID 65532) with explicit securityContext
  - ✅ No binary downloads in chart (pure Kubernetes manifests)
  - ✅ OCI labels included in pod metadata
  - ✅ Supports digest-based image pinning via values
- ✅ **Licensing compliance**: Original Helm chart work; no upstream code copied; compliance section referenced in quickstart
- ✅ **Repository ergonomics**: Standard Helm structure; documented install/upgrade commands; comprehensive values documentation
- ✅ **Testing validation**: E2E tests designed for k3d (works on both architectures); validates deployment without full production Kafka

**No new violations introduced during design phase.**

### Agent Context Updated ✅

GitHub Copilot instructions updated with:
- Language: YAML (Helm templates), Bash/Shell scripting
- Database: N/A (stateless, Kafka backend)
- Project type: Kubernetes Helm chart

---

## Ready for Phase 2 (Tasks)

All planning gates passed. Ready to proceed with:
- `/speckit.tasks` command to break down implementation into actionable tasks
- Implementation of chart templates, e2e tests, and CI integration

**Branch**: `003-helm-chart`  
**Planning artifacts committed**: plan.md, research.md, data-model.md, quickstart.md, contracts/
