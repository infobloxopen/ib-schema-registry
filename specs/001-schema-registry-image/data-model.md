# Data Model: Multi-Architecture Schema Registry Container Image

**Phase**: 1 (Design)  
**Date**: 2026-01-15  
**Purpose**: Define entities and their relationships for the build system

## Overview

This is a **build infrastructure project**, not an application with runtime data models. The "entities" are build artifacts, configuration objects, and metadata structures used during image construction and runtime initialization.

## Entities

### 1. Container Image

**Description**: The primary artifact—a multi-architecture OCI container image containing Schema Registry.

**Attributes**:
- `registry`: String - Container registry hostname (e.g., `ghcr.io`)
- `repository`: String - Image repository path (e.g., `infobloxopen/ib-schema-registry`)
- `tag`: String - Image version tag (e.g., `7.6.1+infoblox.1`, `latest`, `sha-abc123`)
- `platforms`: Array[String] - Supported architectures (`["linux/amd64", "linux/arm64"]`)
- `layers`: Array[Layer] - Image filesystem layers (builder artifacts, runtime files, config)
- `labels`: Map[String, String] - OCI annotations (source, version, revision, created, etc.)
- `entrypoint`: Array[String] - Command to execute (`["java", "-jar", "/app/schema-registry.jar"]`)
- `cmd`: Array[String] - Default arguments (`["/etc/schema-registry/schema-registry.properties"]`)
- `user`: Integer - Runtime UID (65532)
- `workdir`: String - Working directory (`/app`)
- `exposed_ports`: Array[Integer] - Published ports ([8081])

**Relationships**:
- Built from `SourceReference` (upstream submodule)
- Contains `BuildArtifact` (standalone JAR)
- Includes `RuntimeConfiguration` (default properties file)
- Described by `OCILabels` (metadata)
- Generated by `BuildConfiguration` (Makefile/Dockerfile)

**Lifecycle**:
1. Created: Docker build process compiles sources, copies files, applies metadata
2. Stored: Pushed to container registry with manifest referencing platform-specific layers
3. Consumed: Pulled by Docker/Kubernetes runtime, instantiated as container
4. Updated: New build triggered by submodule update or build process change

---

### 2. BuildArtifact

**Description**: The Schema Registry standalone JAR file produced by Maven build.

**Attributes**:
- `source_path`: String - Location in build stage (`package-schema-registry/target/kafka-schema-registry-package-*-standalone.jar`)
- `destination_path`: String - Location in runtime image (`/app/schema-registry.jar`)
- `size_mb`: Integer - Approximate size (150-200 MB typical)
- `format`: String - JAR (Java Archive)
- `dependencies_bundled`: Boolean - True (standalone = fat JAR with all deps)
- `architecture_agnostic`: Boolean - True (JVM bytecode, not native binary)

**Relationships**:
- Produced by `BuildConfiguration` (Maven command)
- Sourced from `SourceReference` (upstream code)
- Packaged into `ContainerImage` (COPY instruction)

**Validation**:
- Must exist after Maven build (Dockerfile fails if glob doesn't match)
- Must be executable JAR with valid manifest
- Must contain `kafka-schema-registry` main class

---

### 3. SourceReference

**Description**: Git submodule pointer to upstream Confluent Schema Registry repository.

**Attributes**:
- `repository_url`: String - `https://github.com/confluentinc/schema-registry`
- `submodule_path`: String - `upstream/schema-registry`
- `commit_sha`: String - Pinned commit (e.g., `abc123def456...`)
- `tag`: String - Upstream version tag (e.g., `7.6.1`, `7.7.0`)
- `branch`: String - Tracking branch (optional, typically unused—pin to tag instead)

**Relationships**:
- Referenced by `BuildConfiguration` (Maven build context)
- Determines version in `OCILabels`
- Compiled into `BuildArtifact`

**Lifecycle**:
1. Initialized: `git submodule add` or `git submodule init`
2. Updated: `git submodule update --remote` or manual checkout of specific tag
3. Validated: Pre-build check ensures submodule is populated
4. Built: Maven executes within submodule directory

---

### 4. RuntimeConfiguration

**Description**: Schema Registry properties file defining runtime behavior.

**Attributes**:
- `file_path`: String - `/etc/schema-registry/schema-registry.properties`
- `listeners`: String - HTTP binding (default: `http://0.0.0.0:8081`)
- `kafkastore_bootstrap_servers`: String - Kafka cluster address (default: `PLAINTEXT://kafka:9092`)
- `kafkastore_topic`: String - Internal topic for schemas (default: `_schemas`)
- `schema_compatibility_level`: String - Validation mode (default: `BACKWARD`)
- `format`: String - Java properties file (key=value pairs)

**Relationships**:
- Packaged into `ContainerImage` (COPY instruction)
- Consumed by Schema Registry at runtime (passed as CMD argument)
- Can be overridden by user (volume mount to same path)

**Customization**:
- Default included in image for development/smoke tests
- Production deployments mount custom config via `-v` or Kubernetes ConfigMap
- Environment variable substitution supported by upstream Schema Registry

---

### 5. BuildConfiguration

**Description**: Makefile variables and Docker build arguments controlling image generation.

**Attributes**:
- `IMAGE`: String - Full image name (registry/repository)
- `TAG`: String - Version tag
- `PLATFORMS`: String - Comma-separated arch list (`linux/amd64,linux/arm64`)
- `BUILDER_IMAGE`: String - Maven+JDK base image
- `RUNTIME_IMAGE`: String - JRE base image
- `APP_UID`: Integer - Runtime user ID (default: 65532)
- `VERSION`: String - Schema Registry version + local suffix
- `BUILD_DATE`: String - RFC 3339 timestamp
- `VCS_REF`: String - Git commit SHA of this repo

**Relationships**:
- Configures `ContainerImage` build process
- References `SourceReference` for version extraction
- Produces `ContainerImage` and `BuildArtifact`

**Sources**:
- Makefile: Default values and variable definitions
- Command-line: Overrides via `make build IMAGE=... TAG=...`
- CI environment: GitHub Actions sets dynamically from git metadata

---

### 6. OCILabels

**Description**: Metadata annotations attached to container image per OCI Image Specification.

**Attributes**:
- `org.opencontainers.image.source`: String - This repository URL
- `org.opencontainers.image.version`: String - Schema Registry version + local suffix
- `org.opencontainers.image.revision`: String - Git commit SHA
- `org.opencontainers.image.created`: String - Build timestamp (RFC 3339)
- `org.opencontainers.image.title`: String - "Confluent Schema Registry"
- `org.opencontainers.image.description`: String - Summary of image purpose
- `org.opencontainers.image.vendor`: String - Organization name (e.g., "Infoblox")
- `org.opencontainers.image.licenses`: String - "Apache-2.0 AND Confluent-Community-1.0" (composite)

**Relationships**:
- Applied to `ContainerImage` (Dockerfile LABEL instructions)
- Derived from `BuildConfiguration` (version, revision, created)
- Derived from `SourceReference` (upstream version)

**Purpose**:
- Provenance tracking (what was built, when, from which source)
- Supply-chain security (enables verification, SBOM correlation)
- Operational visibility (inspect image metadata without running container)

---

### 7. CIWorkflow

**Description**: GitHub Actions workflow automating multi-arch builds and registry pushes.

**Attributes**:
- `name`: String - "Build Multi-Arch Image"
- `triggers`: Array[String] - Event types (`push`, `pull_request`, `tag`)
- `jobs`: Map[String, Job] - Build steps (checkout, QEMU, buildx, push)
- `platforms`: Array[String] - Architectures to build
- `cache_key`: String - Build cache identifier for GitHub Actions cache
- `secrets`: Array[String] - GITHUB_TOKEN for GHCR authentication

**Relationships**:
- Executes `BuildConfiguration` automatically on git events
- Produces `ContainerImage` and pushes to registry
- References `SourceReference` (checks out with submodules)

**Behavior**:
- On PR: Build both architectures, validate, do NOT push
- On push to main: Build, push with `latest` + commit SHA tags
- On version tag push: Build, push with version tag

---

## Relationships Diagram

```text
┌─────────────────┐
│ SourceReference │ (upstream submodule)
└────────┬────────┘
         │ provides source
         ▼
┌─────────────────┐
│ BuildArtifact   │ (standalone JAR)
└────────┬────────┘
         │ packaged into
         ▼
┌─────────────────────────┐
│  ContainerImage         │ ◄──── BuildConfiguration (Makefile/Dockerfile)
│  - platforms            │
│  - layers               │ ◄──── RuntimeConfiguration (config file)
│  - labels (OCILabels)   │
│  - entrypoint/cmd       │
└────────┬────────────────┘
         │ pushed by
         ▼
┌─────────────────┐
│  CIWorkflow     │ (GitHub Actions)
└─────────────────┘
```

## State Transitions

### BuildArtifact State

1. **Not Built** → (Maven compile) → **Compiled**
2. **Compiled** → (COPY to runtime stage) → **Packaged**
3. **Packaged** → (Image push) → **Distributed**

### ContainerImage State

1. **Unbuilt** → (docker build) → **Built Locally**
2. **Built Locally** → (docker push) → **Pushed to Registry**
3. **Pushed to Registry** → (docker pull) → **Running in Container**

### SourceReference State

1. **Uninitialized** → (git submodule init) → **Initialized**
2. **Initialized** → (git submodule update) → **Checked Out**
3. **Checked Out** → (git submodule update --remote) → **Updated to Newer Version**

## Validation Rules

### BuildArtifact

- Glob `package-schema-registry/target/kafka-schema-registry-package-*-standalone.jar` must match exactly one file
- File size must be > 50 MB (sanity check for complete build)
- JAR manifest must contain `Main-Class` attribute

### ContainerImage

- Must build successfully for both `linux/amd64` and `linux/arm64`
- Final image size should be < 500 MB compressed (typical: 200-250 MB)
- Must expose port 8081
- Must run as non-root user (UID 65532)
- Must pass smoke test: `/subjects` returns HTTP 200 within 30 seconds

### RuntimeConfiguration

- `listeners` must bind to `0.0.0.0` (not `localhost` or specific IP)
- `kafkastore.bootstrap.servers` must be valid URI format
- File must be valid Java properties format (no syntax errors)

### OCILabels

- `org.opencontainers.image.source` must be valid HTTPS URL
- `org.opencontainers.image.version` must follow SemVer-ish format (e.g., `7.6.1+infoblox.1`)
- `org.opencontainers.image.revision` must be 40-character hex SHA
- `org.opencontainers.image.created` must be RFC 3339 format

## Notes

- This "data model" describes build-time and metadata entities, not runtime application data
- Schema Registry itself stores schemas in Kafka topic `_schemas` (not managed by this repo)
- Image layers are immutable once built (content-addressable by SHA256 digest)
- Multi-arch manifests use Docker manifest lists (OCI image index) to point to platform-specific images
